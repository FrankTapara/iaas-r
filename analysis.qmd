---
title: ""
author: ""
format:
  html:
    toc: true
    toc-expand: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    self-contained: true
    code-fold: true
    output-file: "ESM"
editor_options: 
  chunk_output_type: console
execute: 
  warning: false
  message: false
  echo: true
---

# Project Setup

```{r}
#| label:  setup

source('https://inkaverse.com/setup.r')
```

# Data import

```{r}
gs <- "https://docs.google.com/spreadsheets/d/15r7ZwcZZHbEgltlF6gSFvCTFA-CFzVBWwg3mFlRyKPs/edit?gid=172957346#gid=172957346" %>% 
  as_sheets_id()

fb <- gs %>% 
  range_read(ss = .,sheet = "fb")
```

# Research Objective

1. 
2.

## RO 1

```{r}

```

## RO 2

```{r}

```

# PCA

```{r}
#| eval: false

dtx <- fb

# str(dtx)
  
mv <- PCA(X = dtx, scale.unit = T, graph = F)

fviz_pca_var(mv, col.var = "cos2"
             , gradient.cols = inti:::paleta()
             , repel = TRUE
             )

var <- plot.PCA(mv, choix = c("var"), cex=0.7, )

ind <- plot.PCA(mv, choix = c("ind")
                , cex = 0.5
                , label = "ind"
                , invisible = "quali"
                )

plot <- list(var, ind) %>% 
  plot_grid(plotlist = ., ncol = 2, labels = "auto") %>% 
  ggsave(plot = ., "manuscript/PCA.jpg", units = "cm"
                , width = 30, height = 15)

plot %>% include_graphics()

pcainfo <- factoextra::get_pca(mv)

sink("files/pca.txt")
cat("\nPrincipal Component Analysis Results\n")
summary(mv, nbelements = Inf, nb.dec = 2)
cat("\nCorrelations between variables and dimensions\n")
mv$cor
cat("\nContributions of the variables\n")
mv$contrib
sink()

cls <- HCPC(mv, graph = F
            , nb.clust = -1
            , metric = "euclidean"
            , method = "ward"
            )

sink("files/hcpc.txt")
cat("\nHierarchical Clustering on Principal Components\n")
cls$call$t$tree
cls$desc.ind
cls$desc.var
sink()

map <- \() {plot(cls, choice = "map", draw.tree = FALSE)}
cir <- fviz_dend(cls, type = "circular", cex = 0.5)

plot <- list(map, cir) %>% 
  plot_grid(plotlist = ., ncol = 2, labels = "auto") %>% 
  ggsave(plot = ., "manuscript/HCPC.jpg", units = "cm"
                , width = 30, height = 15)

plot %>% include_graphics()
```

# References

Broman, K. W., & Woo, K. H. (2017). Data organization in spreadsheets. The American Statistician, 72(1), 2–10. https://doi.org/10.1080/00031305.2017.1375989

Zuur, A. F., Ieno, E. N., & Elphick, C. S. (2009). A protocol for data exploration to avoid common statistical problems. Methods in Ecology and Evolution, 1(1), 3–14. https://doi.org/10.1111/j.2041-210x.2009.00001.x

Francoishusson. (2017, July 13). PCA course using FactoMineR | R-bloggers. R-bloggers. https://www.r-bloggers.com/2017/07/pca-course-using-factominer/

Kozak, M., & Piepho, H. (2017). What’s normal anyway? Residual plots are more telling than significance tests when checking ANOVA assumptions. Journal of Agronomy and Crop Science, 204(1), 86–98. https://doi.org/10.1111/jac.12220

Tanaka, E., & Hui, F. K. C. (2019). Symbolic formulae for linear mixed models. In Communications in computer and information science (pp. 3–21). https://doi.org/10.1007/978-981-15-1960-4_1

Schielzeth, H., Dingemanse, N. J., Nakagawa, S., Westneat, D. F., Allegue, H., Teplitsky, C., Réale, D., Dochtermann, N. A., Garamszegi, L. Z., & Araya‐Ajoy, Y. G. (2020). Robustness of linear mixed‐effects models to violations of distributional assumptions. Methods in Ecology and Evolution, 11(9), 1141–1152. https://doi.org/10.1111/2041-210x.13434

Jambor, H. K. (2025). A checklist for designing and improving the visualization of scientific data. Nature Cell Biology, 27(6), 879–883. https://doi.org/10.1038/s41556-025-01684-z






# Análisis de datos

1. Hacer mi diseño experimental
2. Colectar mis datos
3. Importar los datos
4. Identificar el modelo estadístico
5. Analisis de varianza
6. Prueba de comparación de medias
7. Graficar

# Área foliar

$$y = \mu + Tratamiento + bloque + error$$
$$y = \mu + Tratamiento  + error$$
$$lfa = \mu + riego + geno + riego*geno + bloque + error$$
El modelo es fijo, si quiero cambiar, solo modifico la variable, pero el modelo es el mismo.

# anova

```{r}
str(fb)
md <- aov(formula = lfa ~ bloque + riego + geno + geno*riego, data = fb)
```

También se puede hacer esta forma:

```{r}
md <- aov(lfa~bloque+riego+geno+geno*riego,fb)
```

También se puede hacer de esta otra forma, si eres muy vago :V

```{r}
md <- aov(lfa ~ bloque + riego*geno, fb)

library(emmeans)

em <- emmeans(md, pairwise ~ riego | geno) %>% 
cld(., adjust = "tukey", Letters = letters)
```


El R considera el riego*geno y lo desglosa en 2 formas





### Prueba de comparación de medias

Pegar a la IA: Utilizando el objeto md, hacer la comparación de medias de riego por genotipo, usando el paquete emmeans e incluir las letras de significancia. Para el nivel de riego, iriigado ponerlo azul y sequia en rojo, Y en el eje y poner de título: Área foliar (cm2).



#### grafico
utilizando el objeto em hacer gráfico de barras usando ggplot2 donde en el eje x estén los geno agrupados por riego e incluir la significancia.  Para el nivel de riego, iriigado ponerlo azul y sequia en rojo, Y en el eje y poner de título: Área foliar (cm2).

```{r}
library(ggplot2)
library(dplyr)

# assume em is already in the environment
ggplot(em, aes(x = geno, y = emmean, fill = riego)) +
  geom_col(position = position_dodge(width = 0.9), width = 0.8) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE),
                position = position_dodge(width = 0.9), width = 0.2) +
  geom_text(aes(label = sig, group = riego),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = c(irrigado = "steelblue", sequia = "tomato")) +
  labs(x = "Genotipo", y = "Área foliar (cm2)", fill = "Riego") +
  theme_minimal()
```

```{r}
library(ggplot2)

ggplot(em, aes(x = geno, y = emmean, group = riego, color = riego)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0.2) +
  geom_text(aes(label = .group), vjust = -0.5, size = 3) +
  scale_color_manual(values = c(irrigado = "steelblue", sequia = "tomato")) +
  labs(x = "Genotipo", y = "Área foliar (cm2)", color = "Riego") +
  theme_minimal()


```











```{r}
